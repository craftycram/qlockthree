name: Build and Release qlockthree Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache PlatformIO packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio/.cache
          ~/.platformio/packages
          ~/.platformio/platforms
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install PlatformIO and tools
      run: |
        python -m pip install --upgrade pip
        pip install platformio esptool
        
    - name: Get version from config.h
      id: version
      run: |
        VERSION=$(grep '#define CURRENT_VERSION' include/config.h | cut -d'"' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Build firmware
      run: |
        pio run --environment esp32-c3-devkitc-02
        
    - name: Prepare artifacts
      run: |
        mkdir -p artifacts
        cp .pio/build/esp32-c3-devkitc-02/firmware.bin artifacts/qlockthree-esp32c3-${{ steps.version.outputs.version }}.bin
        cp .pio/build/esp32-c3-devkitc-02/bootloader.bin artifacts/bootloader.bin
        cp .pio/build/esp32-c3-devkitc-02/partitions.bin artifacts/partitions.bin
        
        # Create a combined firmware file
        python -m esptool --chip esp32c3 merge_bin -o artifacts/qlockthree-esp32c3-${{ steps.version.outputs.version }}-complete.bin \
          0x0 artifacts/bootloader.bin \
          0x8000 artifacts/partitions.bin \
          0x10000 artifacts/qlockthree-esp32c3-${{ steps.version.outputs.version }}.bin
        
        # Create build info
        cat > artifacts/build-info.json << EOF
        {
          "version": "${{ steps.version.outputs.version }}",
          "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "git_sha": "${{ github.sha }}",
          "git_ref": "${{ github.ref }}",
          "chip": "ESP32-C3",
          "board": "esp32-c3-devkitc-02"
        }
        EOF
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-esp32c3-${{ steps.version.outputs.version }}
        path: artifacts/
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'release' || github.event.inputs.create_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: qlockthree Firmware v${{ steps.version.outputs.version }}
        body: |
          ## qlockthree Firmware Release v${{ steps.version.outputs.version }}
          
          ### ðŸ“¦ Downloads
          - **`qlockthree-esp32c3-${{ steps.version.outputs.version }}.bin`** - Main firmware (use for OTA updates)
          - **`qlockthree-esp32c3-${{ steps.version.outputs.version }}-complete.bin`** - Complete firmware with bootloader (use for initial flashing)
          
          ### ðŸ”§ Installation Instructions
          
          #### For OTA Updates:
          - The device will automatically detect and install this update if auto-updates are enabled
          - Or use the web interface "Install Update" button
          
          #### For Manual Flashing:
          ```bash
          # Using esptool (recommended)
          esptool.py --chip esp32c3 --port /dev/ttyUSB0 write_flash 0x0 qlockthree-esp32c3-${{ steps.version.outputs.version }}-complete.bin
          
          # Using PlatformIO
          pio run --target upload
          ```
          
          ### ðŸ“Š Build Information
          - **Build Date:** $(date -u +%Y-%m-%d\ %H:%M:%S)\ UTC
          - **Git SHA:** ${{ github.sha }}
          - **Target:** ESP32-C3 DevKit-02
          
          ### âš™ï¸ Features
          - WiFi Configuration Portal
          - OTA Updates
          - Auto-Update from GitHub Releases
          - Web Interface
          - mDNS Support
        files: |
          artifacts/qlockthree-esp32c3-${{ steps.version.outputs.version }}.bin
          artifacts/qlockthree-esp32c3-${{ steps.version.outputs.version }}-complete.bin
          artifacts/bootloader.bin
          artifacts/partitions.bin
          artifacts/build-info.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  notify-success:
    needs: build
    runs-on: ubuntu-latest
    if: success() && (github.event_name == 'release' || github.event.inputs.create_release == 'true')
    
    steps:
    - name: Success notification
      run: |
        echo "âœ… qlockthree firmware build and release completed successfully!"
        echo "ðŸš€ The new firmware is now available for auto-update."
